#!/usr/bin/python
#
# Copyright (C) 2007 Julian Andres Klode <jak@jak-linux.org>
# Copyright (C) 2003-2006 Darren Kirby <d@badcomputer.org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#

"""
dir2ogg converts mp3, m4a, and wav files to the free open source OGG format. Oggs are
about 20-25% smaller than mp3s with the same relative sound quality. Your mileage may vary.

Keep in mind that converting from mp3 or m4a to ogg is a conversion between two lossy formats.
This is fine if you just want to free up some disk space, but if you're a hard-core audiophile
you may be dissapointed. I really can't notice a difference in quality with 'naked' ears myself.

This script converts mp3s to wavs using mpg123 then converts the wavs to oggs using oggenc.
m4a conversions require faad. Id3 tag support requires mutagen for mp3s.
Scratch tags using the filename will be written for wav files (and mp3s with no tags!)
"""

import sys
import os, os.path
import string
import re
from fnmatch import filter
from getopt import gnu_getopt, GetoptError


def getOptions():
    ''' Process command line options/arguments.'''
    try:
        opts, args = gnu_getopt(sys.argv[1:], "dwmfpxagsnvrhVq:", ["directory",
                     "convert-wav", "convert-m4a", "convert-wma", "preserve-wav",
                     "delete-input", "delete-mp3", "delete-m4a", "delete-wma", "shell-protect",
                     "no-mp3", "verbose", "recursive", "help", "version", "quality="])
    except GetoptError:
        error("Invalid option(s)")
        showUsage()
        sys.exit(2)
    q = "3.0" # change from < 0.9.3 behavior

    flags = []
    if len(sys.argv) < 2:
        showBanner()
        showUsage()
        sys.exit(1)
    for opt, arg in opts:
        if opt in ("-h", "--help"):
            showBanner()
            showUsage()
            sys.exit(0)
        elif opt in ("-V", "--version"):
            showLicense()
            sys.exit(0)
        elif opt in ("-w", "--convert-wav"):
            flags.append('w')
        elif opt in ("-m", "--convert-m4a"):
            flags.append('m')
        elif opt in ("-f", "--convert-wma"):
            flags.append('f')
        elif opt in ("-p", "--preserve-wav"):
            flags.append('p')
        elif opt in ("-x", "--delete-input"):
            flags.append('g')
        elif opt in ("-s", "--shell-protect"):
            flags.append('s')
        elif opt in ("-n", "--no-mp3"):
            flags.append('n')
        elif opt in ("-v", "--verbose"):
            flags.append('v')
        elif opt in ("-r", "--recursive"):
            flags.append('r')
        elif opt in ("-q", "--quality"):
            q = arg
        elif opt in ('-d', '--directory'):
            flags.append('d')
        else:
            error("Removed: The option " + opt + " has been removed")
            sys.exit(1)
    return flags, args, q

def info(msg):
    '''print info to the screen (green)'''
    os.system('echo -en $"\\033[0;32m"')
    print "%s" % msg
    os.system('echo -en $"\\033[0;39m"')

def warn(msg):
    '''print warnings to the screen (yellow)'''
    os.system('echo -en $"\\033[1;33m"')
    print "%s" % msg
    os.system('echo -en $"\\033[0;39m"')

def error(msg):
    '''print errors to the screen (red)'''
    os.system('echo -en $"\\033[1;31m"')
    print "*** %s ***" % msg
    os.system('echo -en $"\\033[0;39m"')

def returnDirs(root):
    mydirs = {}
    for pdir, dirs, files in os.walk(root):
        if not pdir in mydirs:
            mydirs[pdir] = files
    return mydirs

class CleanUp:
    '''
    CleanUp: helper methods which tidy up a bit :)

    Note: wavs are deleted by default. use '-p' to save them.
    If you find more characters that break the script please
    post a bug report a https://bugs.launchpad.net/dir2ogg
    '''

    def filterShellKillers(self, ds):
        ''' Filter characters that break the script when fed to bash'''
        if re.search('\!',ds) != "None":
            cs = re.sub('\!', '', ds)
        if re.search(';', cs) != "None":
            cs = re.sub(';', '', cs)
        if re.search('\*', cs) != "None":
            cs = re.sub('\*', '', cs)
        if re.search('"', cs) != "None":
            cs = re.sub('"', '', cs)
        if re.search('&', cs) != "None":
            cs = re.sub('&', 'and', cs)
        if cs != ds:
            os.rename(ds, cs)
            if self.vf:
                warn('"%s" renamed "%s"' % (ds,cs))
        return cs

    def escapeShell(self, songSpaces):
        ''' Convert spaces to underscores.'''
        song = string.replace(songSpaces, ' ', '_')
        os.rename(songSpaces, song)
        return song

class Id3TagHandler:
    '''Class for handling meta-tags.'''
    accept = ['artist', 'title', 'album', 'date', 'comment', 'genre', 'tracknumber']
    def grabCommon(self, handler):
        '''Common grabber, starts the handler and applies the tags to self.tags'''
        mydict = handler(self.song)
        for k,v in mydict.items():
            k = k.lower()
            k = k in self.convert and self.convert[k] or k
            if k in self.accept:
                self.tags[k] = v

    def grabM4ATags(self):
        '''Import MP4 tags handler, set convert and call commonGrab'''
        self.convert = {'\xa9alb': 'album', '\xa9ART': 'artist', '\xa9day': 'date', '\xa9nam': 'title', 'trkn': 'tracknumber', '\xa9gen': 'genre', '\xa9cmt': 'comment'}
        try:
            from mutagen.mp4 import MP4
        except ImportError:
            from mutagen.m4a import M4A as MP4
        self.grabCommon(MP4)

    def grabWMATags(self):
        '''Import ASF tags handler, set convert and call commonGrab'''
        self.convert = {'Author': 'artist',  'AlbumTitle': 'album', 'Year': 'date'}
        from mutagen.asf import ASF
        self.grabCommon(ASF)

    def grabMP3Tags(self):
        '''Import MP3 tags handler, and call commonGrab'''
        self.convert = {}
        from mutagen.easyid3 import EasyID3
        self.grabCommon(EasyID3)

    def listIfVerbose(self):
        info('Meta-tags I will write:')
        for k,v in self.tags.items():
            if type(v) == list:
                info(k + ': ' + ','.join(v))
            else:
                info(k + ': ' + v)

class Convert(Id3TagHandler, CleanUp):
    '''
    Base conversion Class.

    __init__ creates some useful attributes,
    grabs the id3 tags, and sets a flag to remove files.
    Methods are the conversions we can do
    '''

    def __init__(self, song, myopts):
        self.vf = 0
        if 'v' in myopts[0]:
            self.vf = 1
        if 's' in myopts[0]:
            song = self.escapeShell(song)
        if not 'p' in myopts[0]:
            self.rw = 1
        if 'g' in myopts[0]:
            self.ri = 1
        self.song = self.filterShellKillers(song)
        songRoot = string.strip(self.song[:-3])
        wav, ogg = 'wav', 'ogg'
        self.songwav = songRoot + wav
        self.songogg = songRoot + ogg
        self.quality = myopts[2]
        self.BUFFER = '#' * 78

        if fnmatch(self.song, '*.[mM][pP]3'):
            self.grabMP3Tags()
            self.decoder=self.mp3ToWav
        elif fnmatch(self.song, '*.[mM]4[aA]'):
            self.grabM4ATags()
            self.decoder=self.m4aToWav
        elif fnmatch(self.song, '*.[wW][mM][aA]'):
            self.grabWMATags()
            self.decoder = self.wmaToWav
        self.decoder()
        self.wavToOgg()

    def wmaToWav(self):
        ''' Convert wma -> wav.'''
        info('''
        Converting from wma to wav.
        Output from mplayer:

        ''')
        print self.BUFFER
        es = os.system('mplayer -vo null -vc dummy -af resample=44100 -ao ' \
                       'pcm:waveheader "%s" && mv audiodump.wav "%s"' \
                       % (self.song,self.songwav))
        print self.BUFFER
        if es != 0:
            error('mplayer error!')
            ext = self.song.split(".")[-1]
            error('Decoding of "%s" failed. Corrupt %s?' % (self.song, ext))
            self.r3 = 0 #  don't remove the mp3
            return es

    def mp3ToWav(self):
        ''' Convert mp3 -> wav.'''
        info('''
        Converting from mp3 to wav.
        Output from mpg123:

        ''')
        print self.BUFFER
        es = os.system('mpg123 -w "%s" "%s"' % (self.songwav,self.song))
        print self.BUFFER
        if es != 0:
            error('mpg123 error!')
            error('Decoding of "%s" failed. Corrupt mp3?' % (self.song))
            self.r3 = 0 #  don't remove the mp3

    def m4aToWav(self):
        '''Convert m4a -> wav.'''
        info('''
        Converting from m4a to wav.
        Output from faad:

        ''')
        print self.BUFFER
        es = os.system('faad "%s"' % self.song)
        print self.BUFFER

        if es == 32512 and self.wmaToWav() != 0:
            self.r4 = 0
        elif es != 0:
            error('faad error!')
            error('Decoding "%s" failed. Corrupt m4a?' % self.song)
            self.r4 = 0

    def wavToOgg(self):
        ''' Convert wav -> ogg.'''
        if self.vf:
            self.listIfVerbose()
        info('Converting from wav to ogg. - Output from oggenc:')
        print self.BUFFER
        if self.songwav:
            es = os.system('oggenc -q3 "%s"' % self.songwav)
            print self.BUFFER
            if es != 0:
                error('Encoding of "%s" failed.' % self.songwav)
            elif self.rw:
                os.remove(self.songwav)
        if self.ri:
            os.remove(self.song)
        # Add tags to the ogg file
        from mutagen.oggvorbis import OggVorbis
        myogg = OggVorbis(self.songogg)
        myogg.update(self.tags)
        myogg.save()

class ConvertDirectory:
    '''
    This class is just a wrapper for Convert.

    Grab the songs to convert, then feed them one
    by one to the Convert class.
    '''

    def __init__(self, myopts, d, files=None):
        ''' Decide which files will be converted.'''
        if os.path.exists(d) == 0:
            error('Directory: "%s" not found' % d)
            sys.exit(1)

        self.d = d = os.path.normpath(d) + os.path.sep
        self.songs = files and files or os.listdir(d)
        self.m4as  = 'm' in myopts[0] and filter(self.songs, '*.[mM]4[aA]') or []
        self.mp3s  = 'n' in myopts[0] and [] or filter(self.songs, '*.[mM][pP]3')
        self.wavs  = 'w' in myopts[0] and filter(self.songs, '*.[wW][aA][vV]') or []
        self.wmas  = 'f' in myopts[0] and filter(self.songs, '*.[wW][mM][aA]') or []

        if 'v' in myopts[0]:
            self.printIfVerbose(myopts)

        for m4a in self.wmas +  self.mp3s + self.wavs + self.m4as:
            Convert(d + m4a, myopts)

    def printIfVerbose(self, myopts):
        ''' Echo files to be converted if verbose flag is set.'''
        info('In %s I am going to convert:' % self.d)
        if not 'n' in myopts[0]:
            for mp3 in self.mp3s:
                info(mp3)
            if len(self.mp3s) == 0:
                warn('No mp3s in %s' % self.d)
        if 'm' in myopts[0]:
            for m4a in self.m4as:
                info(m4a)
            if len(self.m4as) == 0:
                warn('No m4as in %s' % self.d)
        if 'f' in myopts[0]:
            for wma in self.wmas:
                info(wma)
            if len(self.wmas) == 0:
                warn('No wmas in %s' % self.d)
        if 'w' in myopts[0]:
            for wav in self.wavs:
                info(wav)
            if len(self.wavs) == 0:
                warn('No wavs in %s' % self.d)
        print

def showUsage():
    print '''Usage: dir2ogg [options] ( file1 [file2..x] || directory1 [directory2..x])
    Options:
       '-d'  or '--directory'      convert files in all directories specified as arguments
       '-r'  or '--recursive'      convert files in all subdirectories of all directories specified as arguments
       '-w'  or '--convert-wav'    convert wav files (use with '-d')
       '-p'  or '--preserve-wav'   preserve all wav files after converting to ogg
       '-m'  or '--convert-m4a'    convert m4a files (use with '-d')
       '-f'  or '--convert-wma'    convert wma files (use with '-d')
       '-n'  or '--no-mp3'         don't convert mp3s (use with '-d', and '-c' and/or '-m')
       '-x'  or '--delete-input'   delete the input file(s)
       '-s'  or '--shell-protect'  replace spaces with underscores
       '-qN' or '--quality=N'      quality. N is a number from 1-10 (see 'man oggenc')
       '-v'  or '--verbose'        increase dir2ogg's verbosity
       '-V'  or '--version'        print version number and license informations
       '-h'  or '--help'           print this summary
    '''

def showBanner():
    print 'dir2ogg 0.11 alpha 1, (C) Julian Andres Klode and Darren Kirby. Released under GPL'
    print

def showLicense():
    print """dir2ogg 0.11 alpha 1; released 2007-07-29

Copyright (C) 2007 Julian Andres Klode <jak@jak-linux.org>
Copyright (C) 2003-2006 Darren Kirby <d@badcomputer.org>

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

Currently developed by Julian Andres Klode <jak@jak-linux.org>."""

def main():
    myopts = getOptions()
    showBanner()

    if 'r' in myopts[0]:
        rdirs = {}
        for d in myopts[1]:
            if os.path.exists(d) == 0:
                error('Directory: "%s" not found' % d)
                sys.exit(1)
            l = returnDirs(d)
            rdirs.update(l)
        if len(rdirs) == 0:
            error('No files to convert!')
            sys.exit(1)
        for directory,files in rdirs.items():
            ConvertDirectory(myopts, directory, files)

    elif 'd' in myopts[0]:
        for d in myopts[1]:
            if os.path.exists(s) == 0:
                error('Directory: "%s" not found' % s)
                sys.exit(1)
        for d in myopts[1]:
            ConvertDirectory(myopts, d)

    else:
        files  = filter(myopts[1], '*.[mM][pP]3')    + filter(myopts[1], '*.[mM]4[aA]')
        files += filter(myopts[1], '*.[wW][mM][aA]') + filter(myopts[1], '*.[wW][aA][vV]')

        for s in files:
            if os.path.exists(s) == 0:
                error('File: "%s" not found' % s)
                sys.exit(1)

        for s in files:
            Convert(s, myopts)

    sys.exit(0)

if __name__ == '__main__':
    main()
